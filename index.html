<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Draw</title>

  <!-- iOS / PWA icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">

  <!-- iOS PWA meta -->
  <meta name="theme-color" content="#0b2018">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root{
      --bg:#0b2018;
      --surface:#0f2a20;
      --card:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --accent:#2dd4a6;
      --accent2:#a3f7d8;
      --radius:16px;
      --tap:48px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 30% -10%, rgba(45,212,166,.18), transparent 55%),
        linear-gradient(180deg,#081a13,var(--bg));
      color:var(--text);
    }

    .wrap{
      max-width:1100px;
      margin:auto;
      padding:18px 14px 120px;
    }

    h1{margin:0;font-size:22px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

    .pill{
      padding:8px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--border);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .dot{
      width:8px;height:8px;border-radius:50%;
      background:#ffb020;
    }
    .dot.ok{background:var(--accent)}

    .grid2{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:14px;
      margin-top:14px;
    }
    @media(max-width:980px){
      .grid2{grid-template-columns:1fr}
    }

    .panel{
      background:rgba(255,255,255,.04);
      border:1px solid var(--border);
      border-radius:var(--radius);
      overflow:hidden;
    }

    .panelHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }

    .panelBody{padding:14px}

    .btn{
      height:var(--tap);
      border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.08);
      color:var(--text);
      font-weight:700;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      color:#042015;
      border:none;
    }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .field{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      margin-top:10px;
      font-size:13px;
    }

    input[type=time],select{
      background:#0a1812;
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text);
      padding:6px 10px;
    }

    details{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
    }
    summary{
      padding:12px;
      cursor:pointer;
      font-weight:700;
    }

    .playersGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
      padding:10px;
    }

    .tile{
      background:rgba(255,255,255,.06);
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight:700;
      font-size:13px;
    }

    .toggle{
      width:40px;height:22px;
      background:rgba(255,255,255,.2);
      border-radius:999px;
      position:relative;
    }
    .toggle::after{
      content:"";
      position:absolute;
      top:2px;left:2px;
      width:18px;height:18px;
      background:#fff;
      border-radius:50%;
      transition:.2s;
    }
    input.cb{display:none}
    input.cb:checked + .toggle{background:var(--accent)}
    input.cb:checked + .toggle::after{left:20px}

    .resultItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      margin-bottom:8px;
    }
    .timeBadge{
      background:rgba(45,212,166,.2);
      border:1px solid rgba(45,212,166,.4);
      color:var(--accent2);
      padding:6px 10px;
      border-radius:10px;
      font-weight:800;
      min-width:64px;
      text-align:center;
    }

    textarea{
      width:100%;
      min-height:160px;
      background:#0a1812;
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--text);
      padding:12px;
      margin-top:10px;
    }

    .sticky{
      position:fixed;
      bottom:0;left:0;right:0;
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(10px);
      padding:10px;
    }
    .sticky .btn{width:100%}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Draw</h1>
  <div class="subtitle">Sélectionne les présents, renseigne le 1er départ, puis génère.</div>

  <div class="pill" id="countPill">
    <span class="dot" id="countDot"></span>
    <span id="countText">0 présents</span>
  </div>

  <div class="grid2">
    <section class="panel">
      <div class="panelHead">
        <button class="btn primary" id="btnGenerate">Générer</button>

        <div class="actions">
          <button class="btn" id="btnAll">Tout cocher</button>
          <button class="btn" id="btnNone">Tout décocher</button>
        </div>

        <div class="field">
          <span>1er départ</span>
          <input type="time" id="startTime">
        </div>

        <div class="field">
          <span>Intervalle</span>
          <strong style="color:var(--accent2)">+8 min</strong>
        </div>
      </div>

      <div class="panelBody">
        <details open>
          <summary>Joueurs</summary>
          <div class="playersGrid" id="playersGrid"></div>
        </details>

        <details>
          <summary>Invités</summary>
          <div class="playersGrid" id="guestsGrid"></div>
        </details>
      </div>
    </section>

    <section class="panel">
      <div class="panelHead">
        <button class="btn primary" id="btnCopy">Copier WhatsApp</button>
      </div>
      <div class="panelBody">
        <div id="result"></div>
        <textarea id="waText" readonly></textarea>
      </div>
    </section>
  </div>
</div>

<div class="sticky">
  <button class="btn primary" onclick="generate()">Générer</button>
</div>

<script>
  const players=["RG","AT","GDG","GG","PZ","BD","NH","TLT","JD","CG","JMP","JPG","AP","TM","HDS","AC","TB","SL","TBU","JLH"];
  const guests=["INV1","INV2","INV3"];
  const INTERVAL=8;

  const presence=JSON.parse(localStorage.getItem("draw_presence")||"{}");

  function render(list,container,prefix){
    container.innerHTML="";
    list.forEach(n=>{
      const key=prefix+n;
      const d=document.createElement("div");
      d.className="tile";
      d.innerHTML=`${n}<label><input class="cb" type="checkbox" ${presence[key]?"checked":""}><span class="toggle"></span></label>`;
      d.querySelector("input").onchange=e=>{
        presence[key]=e.target.checked;
        localStorage.setItem("draw_presence",JSON.stringify(presence));
        updateCount();
      };
      container.appendChild(d);
    });
  }

  function getPresent(){
    return [...players.filter(p=>presence["P"+p]),...guests.filter(g=>presence["G"+g])];
  }

  function groupSizes(n){
    if(n%4===0)return Array(n/4).fill(4);
    if(n%4===1)return [3,3,3,...Array((n-9)/4).fill(4)];
    if(n%4===2)return [3,3,...Array((n-6)/4).fill(4)];
    return [3,...Array((n-3)/4).fill(4)];
  }

  function shuffle(a){
    a=[...a];
    for(let i=a.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  }

  function generate(){
    const list=shuffle(getPresent());
    const sizes=groupSizes(list.length);
    let idx=0;
    const groups=sizes.map(s=>list.slice(idx,idx+=s));

    const start=document.getElementById("startTime").value||"08:00";
    const [h,m]=start.split(":").map(Number);
    let cur=h*60+m;

    const res=document.getElementById("result");
    const wa=[];
    res.innerHTML="";

    groups.forEach(g=>{
      const hh=String(Math.floor(cur/60)).padStart(2,"0");
      const mm=String(cur%60).padStart(2,"0");
      const line=`${hh}:${mm} : ${g.join(" / ")}`;
      wa.push(line);

      const div=document.createElement("div");
      div.className="resultItem";
      div.innerHTML=`<div class="timeBadge">${hh}:${mm}</div><div>${g.join(" / ")}</div>`;
      res.appendChild(div);

      cur+=INTERVAL;
    });

    document.getElementById("waText").value=wa.join("\n");
  }

  function updateCount(){
    const n=getPresent().length;
    document.getElementById("countText").textContent=n+" présents";
    document.getElementById("countDot").className="dot"+(n>=3?" ok":"");
  }

  document.getElementById("btnGenerate").onclick=generate;
  document.getElementById("btnCopy").onclick=()=>navigator.clipboard.writeText(document.getElementById("waText").value);
  document.getElementById("btnAll").onclick=()=>{players.forEach(p=>presence["P"+p]=true);guests.forEach(g=>presence["G"+g]=true);localStorage.setItem("draw_presence",JSON.stringify(presence));renderAll();};
  document.getElementById("btnNone").onclick=()=>{Object.keys(presence).forEach(k=>presence[k]=false);localStorage.setItem("draw_presence",JSON.stringify(presence));renderAll();};

  function renderAll(){
    render(players,playersGrid,"P");
    render(guests,guestsGrid,"G");
    updateCount();
  }

  renderAll();
</script>
</body>
</html>
